name: Automated Commit

on:
  push:
    branches: [main]

  schedule:
    - cron: '*/10 * * * *' # Executes every 10 minutes

  workflow_dispatch:

permissions:
  contents: write

jobs:
  update_commit:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Debug Information
        run: echo "::debug::Triggered by ref = ${{ github.ref }}"

      - name: Checkout the Code
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Update README
        run: |
          current_time=$(date '+%Y-%m-%d %H:%M:%S')
          echo "Updated on $current_time" > README.md

      - name: Git Configuration
        run: |
          git config user.email "crpt.dreamer@gmail.com"
          git config user.name "p99fun"

      - name: Stash Local Changes
        run: |
          git add . # Stage changes
          git stash # Stash them temporarily

      - name: Fetch and Rebase Latest Changes
        run: |
          git fetch --all
          git pull origin main --rebase || echo "Rebase failed, attempting to resolve conflicts."

      - name: Resolve Conflicts
        if: failure() # This step only runs if the "Fetch and Rebase" step fails
        run: |
          conflict_files=$(git diff --name-only --diff-filter=U) # Get conflicting files
          for file in $conflict_files; do
            echo "Resolving conflict for $file"
            git checkout --ours "$file" # Keep the local changes (overwrite conflicts)
            git add "$file" # Mark resolved
          done
          git rebase --continue || echo "Rebase completed or already skipped."

      - name: Apply Stashed Changes
        run: |
          git stash pop || echo "No changes to apply from stash."

      - name: Final Commit
        run: |
          commit_messages=("Update: â°" "Refresh: ğŸ”„" "Renew: ğŸŒŸ" "Revise: ğŸ“" "Amend: ğŸ› " "Adjust: ğŸ”§" "Change: ğŸ“ˆ" "Modify: ğŸ–Š" "Transform: ğŸŒ€" "Revamp: ğŸŒˆ")
          random_msg=${commit_messages[$RANDOM % ${#commit_messages[@]}]}

          git add .
          git commit -m "$random_msg - $current_time" || echo "No changes to commit."

      - name: Push Changes
        run: |
          git push origin main
